# Beta版 ビルドガイド

## 作業前の準備
### 必須パーツ
販路やイベントにより販売時の内容は異なります。足りないものをそれぞれ揃えてください。
 - 基板  
   1枚  
   「75% JIS Row Staggered Keyboard "Constant Moderato"」と、バージョン情報が書き込まれた面が裏側となります。  
   ほぼすべての作業を**裏面**に行います。  
   ビルドガイド内で左右を指定している場合、傾斜のある方が手前となります。
 - スイッチプレート  
   1枚  
   裏表を判別するマーク等はありません。スイッチの位置を合わせてください。  
 - バックプレート  
   1枚  
   リバーシブルです。好きなデザインでどうぞ。
 - ゴム足  
   同形状のものが4つ入っています。  
   傾斜を付けたい場合は適切なものを購入してください。  
 - ネジ  
   M2×3、M2×7を7本ずつ使用します。  
 - スペーサー  
   M2×2mm、M2×3.5mmを7本ずつ使用します。
 - 作業用ピンヘッダ  
   短いもので問題ありません。2本ほど必要です。  
 - Waveshare RP2040-Zeroまたは互換基板  
   1個
 - Cherry MX互換キースイッチ  
   87個
 - MX軸キーキャップ  
   1セット JIS配列推奨  
   ※「キーキャップの選定」参照
 - MXキーソケット  
   88個 Kailh製のものを想定しています。
 - ダイオード  
   87個 1N4148シリーズ 表面実装タイプ
 - MX用 スタビライザー  
   1～3個　PCBマウントタイプ
   ※「キーキャップの選定」参照

### LED実装時のオプションパーツ類
 - LED SK6812MINI-E  
   26個
 - ダイオード  
   2個 1N4148が使用可能です。
 - コンスルー  
   LEDを実装する際は、通電確認に使うと楽です。実装に使用するわけではありません。
   
### 必須工具類
 - はんだ作業関連品一式  
 - USB TypeC通信用ケーブル  
### 推奨工具類
 - はんだ作業用マット  
   はんだ面の中にビア(導電のための貫通穴)を設けてあるため、稀にここを通って裏にフラックスが回る場合があります。  
   机を汚したくない場合は敷くといいでしょう。
 - ゲタ  
   便宜上ゲタと呼んでいますがスルーホールパーツなどを実装する際に基板の下に敷いて高さを稼ぎ、パーツの浮きを防ぐためのものです。  
   非導電性で厚さ3mmほどあればいいので、割りばしなどを折ったもので構いません。  
 - キープラー
 - 油性マーカー(白)  
 - マスキングテープ  
### 必要ファイルのダウンロード
 - constant_moderato-****.uf2  
   ファームウェアです。ハイフン以降がバージョン情報となり、基本的に最新のものが利用できます。  
   ※稀に特殊な用途のファームウェアがあるので、使用前にビルドガイドを確認し、分からないものは使わないでください。  
 - [Vial](https://get.vial.today/)  
   キーマップを書き換えるためのソフトウェアです。  
   オンライン版でも問題なく利用できますが、ダウンロード版だと日本語表示、JISキーに対応していることと、マトリクスチェッカーの反応が早くて良いのでお勧めです。
  
## キーキャップの選定
以下の条件を満たすセットであれば主要なキーをカバーできます。  
 - 75%以上のセット  
 - JIS配列対応  
   
100%のキットであればほぼ完璧にカバー可能ですが、最下段のキー幅によっては個別購入が必要になります。  
最下段の構成は以下の通りです。
- 1.25u Ctrl
- 1.25u Win
- 1.25u Alt
- 1.5uまたは1.25u 無変換
- 2.75uまたは3u Space
- 1.5uまたは1.25u 変換
- 1.25u カナ
- 1.25u Menu
- 1.25u Ctrl
- 十字キー

このキーボードを特徴づける要素として、キー幅の複数対応があります。例えば、左Shift(2.25u)は、1u Fnと1.25u Shiftに分割可能です。  
また、1.5uの無変換・変換には2.75u Spaceが、1.25uの無変換・変換には3u Spaceが対応するようになっています。  
好みとセットの内容に合わせて調整してください。  
おすすめはSpaceを2.75u、無変換・変換を1.5nにすることです。この幅だとキーの隙間が一定になります。  
  
その他のキーも足りない場合は適宜単品購入して合わせます。  

[具体的なキー幅はKLEでも確認できます。](https://www.keyboard-layout-editor.com/##@@=0,0&_x:0.75%3B&=0,2&=0,3&=0,4&=0,5&=0,6&=0,7&_x:1.25%3B&=6,1&=6,2&=6,3&=6,4&=6,5&=6,6&_x:0.75%3B&=6,7%3B&@_y:0.25%3B&=1,0&=1,1&=1,2&=1,3&=1,4&=1,5&=1,6&=1,7&=7,0&=7,1&=7,2&=7,3&=7,4&=7,5&=7,6&_x:0.75%3B&=7,7%3B&@_w:1.5%3B&=2,0&=2,1&=2,2&=2,3&=2,4&=2,5&=2,6&=2,7&=8,0&=8,1&=8,2&=8,3&=8,4&_x:0.25&w:1.25&h:2&w2:1.5&h2:1&x2:-0.25%3B&=8,6&_x:0.75%3B&=8,7%3B&@_w:1.75%3B&=3,0&=3,1&=3,2&=3,3&=3,4&=3,5&=3,6&=3,7&=9,0&=9,1&=9,2&=9,3&=9,4&_x:2%3B&=9,7%3B&@=4,0%0A%0A%0A0,0&_w:1.25%3B&=4,1%0A%0A%0A0,0&=4,2&=4,3&=4,4&=4,5&=4,6&=4,7&=10,0&=10,1&=10,2&=10,3&=10,4&_w:1.25%3B&=10,5&_x:1.25%3B&=10,7%3B&@_y:-0.875&x:14.625%3B&=10,6%3B&@_y:-0.125&w:1.25%3B&=5,0&_w:1.25%3B&=5,1&_w:1.25%3B&=5,2&_x:6&w:1.25%3B&=11,2&_w:1.25%3B&=11,3&_w:1.25%3B&=11,4%3B&@_y:-0.875&x:3.88&w:1.5%3B&=5,4%0A%0A%0A1,0&_w:2.75%3B&=5,6%0A%0A%0A1,0&_w:1.5%3B&=11,0%0A%0A%0A1,0&_x:3.995000000000001%3B&=11,5&=11,6&=11,7%3B&@_y:0.125&w:2.25%3B&=4,1%0A%0A%0A0,1&_x:1.75&w:1.25%3B&=5,4%0A%0A%0A1,1&_w:3%3B&=5,6%0A%0A%0A1,1&_w:1.25%3B&=11,0%0A%0A%0A1,1)  

## ファイルの確認
ファイル名末尾の **** の部分はバージョン情報や特殊なファームウェアに関する情報です。基板のバージョンとファームウェアのバージョンには関連がありませんので、Ver.BETAを除いては特別な理由がない限り最新のものを使用してください。  
全て本リポジトリ内の/Firm/Ver-****/以下で入手できます。  
### constant_moderato-****.uf2
キーボードを制御するためのファームウェアです。  

### Vial
[Vial公式](https://get.vial.today/)からダウンロードできる、リアルタイムでキーボードの設定を変更できるソフトウェアです。  
日本語配列への表示変更が可能で認識の早いダウンロード版をおすすめしますが、Web版でも問題なく使用できます。  

## RP2040-Zeroの作業
### 動作確認
BOOTボタンを押しながらPCとRP2040-Zeroを接続し、ストレージとして認識されたら.uf2ファイルをコピーします。  
書き込みが終わった段階でストレージとして認識されなくなり、かわりにHIDデバイスとして接続されるはずです。  
一旦書き込んだらVialの使用が可能になるので、Vialを起動し、キーボードが表示されていることを確認します。  
<details><summary>うまくいかない場合</summary>  
通信用ケーブルで接続していることを確認してください。  
 
稀にPC側のポート自体が破損していて通電していてもデータ通信が行えないこともあります。(一敗)  
PCに接続してから「BOOTボタンを押しながら、RESETボタンを押す」という方法でも接続が可能です。  
   
  それでも認識しなかったり、書き込めない場合は初期不良かもしれません。
</details>  

## はんだ前の作業

### 基板端の処理(任意)
尖った部分がある場合はヤスリで削ります。  
基板の端(断面)をマーカーで塗ると綺麗に見えます。  

### RP2040-Zeroの塗装(任意)
ボタン部と端子のある辺の基板端を塗ると組み立てた後も目立たなくなります。  

### ロゴと文字の保護(任意)
基板の文字ははんだ面で表示しているため、はんだやフラックスが付くと汚れてしまいます。  
心配な場合は、マスキングテープやカプトンテープを貼り付けておき、はんだ作業が終わった時点で剥がすといいでしょう。  
<details><summary>はんだ付いちゃった……</summary>一応剥がす手段があります。  

- まず、付近のはんだ面含めてはんだを多めに盛る。 
- はんだ回収線を用いて全体を一気にクリーニングする。
- フラックスリムーバーで汚れを洗浄する。

  HASLと異なり、はんだを吹き飛ばすことはないため、多少の凹凸は残ります。  
  製造段階では基本的に有鉛ハンダを使用しているため、この作業を行う際も有鉛ハンダをお勧めします。  
  流動性が良いので、回収しやすく凹凸が減り、なおかつ有鉛無鉛を混合することによる強度低下を抑えることができます。  
</details>

## 部品のはんだづけ
ここから先は大量のパーツをはんだづけすることになります。  
途中で休憩もできますが、一度にやってしまうのが楽でしょう。  

### LEDと周辺のはんだづけ(任意)
LEDをはめこむ穴のうち、角が欠けている部分がGNDとなり、LED側の足の角が欠けている部分を合わせると正しい方向になります。  
ロータリーエンコーダーのLED15/16、EnterキーのLED46は向きが違うので注意してください。
発光面は基板オモテ側を向くようになります。丸い透明な樹脂がはまっている面が発光面です。  
RP2040-Zeroの入る隙間脇の、D1にダイオードをはんだづけします。  
この際、1N4148シリーズを使用するなら基板ウラで問題ありませんが、1N4007など直径1.8mmを超えるリードダイオードに関しては基板オモテに実装してください。  
<details><summary>LEDが正しくはんだづけできているか不安…</summary>コンスルーを使用し、基板とMCUを接続してみてください。
  
問題なくはんだづけできれていれば、通電すると赤色に光るはずです。この状態でVialを使用し、Backlightingのタブから色やアニメーションを切り替えましょう。  

問題なく接続できているなら、なめらかに切り替わりますが、接続が不安定だと、その部分から先のLEDは不安定になります。</details>なお、LED15と16は同じ光り方になるように制御しています。

### RP2040-Zeroのはんだづけ
RP2040を基板のオモテ側に載せ、端子のある面がウラ側に向くようにします。  
この状態で付属のピンヘッダやコンスルーを突き刺し、RP2040が動かないようにして、ピンヘッダを刺している場所以外の端面スルーホールをはんだづけしていきます。  
ピンヘッダにははんだづけを行わず、RP2040が軽く固定できた時点で抜いて、残りの端面スルーホールもはんだづけしてください。  

<details><summary>実際に使っているピンはどれ？</summary>マトリクススキャンはGP1～8、14、15、26～29、LED DOUTにGP0、LED用動力線の5V0、GND、ロータリーエンコーダーの制御にGP12とGP13です。</details>  
LEDを実装している場合、MCUに通電すれば赤色に発光するはずです。

### トラブルシューティング(1)
<details><summary>LEDがすべて光らない</summary>D1、L1、5V0、GND、GP0は問題なくはんだ付けできていますか？ケーブルは断線していませんか？</details>  
<details><summary>LEDが途中から光らない・ちらつく</summary>光らない/ちらつくLED自体のはんだづけと、1個前のLEDのはんだを確認してください。稀にRGB MatrixとRGB Lightingが同時に起動してしまうことがあり、この状態だと通電状態のLEDすべてが強くちらつくことになります。Vial経由でLightingをDisableし、Saveするなどで解決します。</details>  
<details><summary>LED15・16・17がおかしい</summary>ロータリーエンコーダー周辺のLEDは分岐しており、LED14から15と16を接続し、15から17を接続しています。それぞれの接続を確認してください。</details>
<details><summary>LEDがしばらく光った後に光らなくなった</summary>一度キーボードをPCに接続し、VialのLED制御を用いて光量(Brightness)を下げます。この状態でケーブルを外してダイオードを交換し、再度通電させてみてください。これで治る場合は、過電流によりダイオードが破壊されています。一般整流ダイオードなどに変更してください。</details>
<details><summary>それ以外の問題・治らない場合・わからない場合</summary>製作者に連絡してください。</details>
  
### ダイオードのはんだづけ
1N4148シリーズ表面実装タイプの使用を想定しています。**配線最適化と破損防止のため、向きを統一していません**  
シルクスクリーンとダイオードの向きを揃えてはんだづけしてください。矢印の向く方向にダイオード表面の線が来ます。  
高さが1.9mmを超えるとバックプレートと干渉するため注意してください。また、シルクスクリーンの枠を外れるとスイッチソケットと干渉するおそれがあります。  
  
ダイオードのはんだづけに不安がある場合はここで導通確認を行います。  
VialのMatrix Testerを使用し、スイッチソケットのパッドにワイヤーやピンセットを当てて反応を確認してください。

### スイッチソケットのはんだづけ
シルクスクリーンとソケットの向きを揃えてはんだづけしてください。  
あまり大量にはんだを流すと端子部だけでなくソケット部にまで流れ込み、押し込みが硬くなったり、導通しなくなってしまうので注意してください。  
クリアランスを0.2mmほどに設定しているため、浮きがあるとバックパネルが取り付けられなくなります。基板に密着していることを確認しながらはんだづけしてください。

### 導通確認
Matrix Testerを使用し、以下の方法のいずれかで基板の導通を確認します。  
- スイッチをはめ、押してみて反応を見る。
- はんだ付けしたソケットの脚にピンセットやワイヤーをあてて導通させる。  
  
すべてのキーが間違いなく反応している状態であれば問題ありません。  
そうでない場合、トラブルシューティング(2)を確認して対応してください。

### トラブルシューティング(2)
<details><summary>キーが反応しない・別のキーが反応する(1個単位)</summary>ダイオードの方向、ソケットのはんだを確認してください。スイッチ自体の導通も見ましょう。  
  
※はんだ部分はヤニでコーティングされるため、ピンセットを強く押し当てないと通電しないことがあります
</details>  
<details><summary>行・列単位でキーが反応しない・たくさん反応する</summary>RP2040のはんだ不良を疑います。ピンとパッドが問題なく接続されていること、周辺のパッドと短絡していないことを確認してください。</details>  
<details><summary>勝手に反応する</summary>はんだの短絡を疑います。多すぎる場所から回収してください。稀に外部からのノイズで発生することもあるため、通信機器から少し離すなどもしてみてください。</details>
<details><summary>それ以外の問題・治らない場合・わからない場合</summary>製作者に連絡してください。</details>

## 組み立て
### スタビライザーの静音化(任意)
スタビライザーを分解して摺動部とワイヤーの端をたっぷりのグリスでコーティングします。  
スタビライザーの足元(穴と穴のあいだ)に静音パッドを貼ります。ない場合はマスキングテープや不織布テープ、絆創膏の粘着部を切って貼ります。  
テープの枚数は基板との隙間によりけり。多すぎると固定用の爪が噛まなくなるので適度にゲタを履かせましょう。  

### スタビライザーの取付け
ワイヤーが露出する部分は基板上に線で表示されています。  

### 組み付け
まずバックパネルの表から7mmのネジを通し、2mmのスペーサーで固定します。  
この上に基板を重ねます。  
基板から飛び出したネジに3.5mmスペーサーを留め、スイッチプレートを乗せて3mmネジで固定します。  
ゴム足はバックプレートの四隅に僅かにへこみがある場所に貼り付けてください。

### スイッチ・キーキャップの実装
好みのスイッチとキーキャップを実装してください。  
一般的なMX互換スイッチ・キーキャップであれば使用できます。  
それぞれの相性についてはREADMEを確認してください。

# マッピングガイド
キーマップの書き換えにはVialを使用します。ダウンロード版の方は日本語配列にも対応しており、マトリクステスターの反応も早いため使いやすいと思います。  

## 初期状態
デフォルトで設定されているのはJIS配列を踏襲した配置となっており、通常のJISキーボードからの移行でも違和感なく使用できるはずです。  

## 書き換え
キーボードをPCに接続し、Vialを起動し、表示されたキーから変更したいものを選ぶ→画面下のリストからキーコードを選ぶ  
という手順で書き換えが可能です。  
タップダンスやコンボなど、詳細な使用方法はVialの公式ドキュメントなどを参照してください。

# カスタムガイド
## おすすめキースイッチ
スイッチプレート、基板、バックパネルを完全に固定する構造のため、サンドイッチマウントとしては剛性がかなり高くなっています。  
場所による癖が少なく、全体に亘って硬めの打鍵感となっているため、打鍵感を柔らかくしたい場合はフォームシートやサイレントスイッチを採用するのがおすすめです。 
## おすすめキーキャップ
Acid Capsシリーズを使用するとほとんどのレジェンドを合わせることができます。  
論理配列は通常の65%JISキーボードに近いため、手が覚えているなら無刻印キーキャップでも問題なく使用可能かと思います。  
現行品ではキーソケットの方向を逆方向に揃えているため、CherryプロファイルとMXスイッチの組み合わせでは干渉することがあります。  
LEDは上側にあるため、Double Shot Backlit系キーキャップが良く光ります。

## ファームウェアの改造
[ここにあります。](https://github.com/Cheena-gb/vial-qmk/tree/vial/keyboards/cheena/re_aoharu)  
改造ファームの不具合、それに起因する故障などについてはサポートできませんのでご了承ください。  
また、DefaultとVIA用のキーマップには作業を行っていないため動きません。  

基板上のL15とL16はL14から分岐する形で制御しており、L15とL16は同じ光り方になります。  
ファームウェア上では一つのLEDとして認識されるため、LEDは88個が上限ということになります。  
RGB LightとRGB Matrixの切り替えや制御を行う際は注意してください。

